<!-- USAGE: Add a div to contain the bloom bar: -->
<!-- <div class="bloom"> -->
<!-- </div> -->

<!-- THEN ON JS: Load the component and listen to value changes -->

<!-- $(".bloom").load("custom/bloom/custom-bloom.html", function() {

$('custom-bloom').on('rate', () => {

//new value assigned:
let newVal = $('custom-bloom').val();
console.log(newVal);

});

}); -->

<!-- To disable: -->
<!-- $('custom-bloom').prop('enabled', false); -->

<custom-bloom>
</custom-bloom>

<style>
    custom-bloom {
        display:flex;
    }

    custom-bloom > .wrapper > .star {
        margin-left: 3px;
        margin-right: 3px;
        width:45px;
        height:45px;

        /* Path is actually from the page that is calling... */
        background-image: url('custom/bloom/ic_bloom_empty.png');
        position: relative;
        z-index: initial;
        background-size: cover;
    }

    custom-bloom > .wrapper > .star.full {
        margin-left: 3px;
        margin-right: 3px;
        width:45px;
        height:45px;

        /* Path is actually from the page that is calling... */
        background-image: url('custom/bloom/ic_bloom_full.png');
        background-size: cover;
    }

    custom-bloom > .wrapper > .star.full > .bubbles {
        animation: bounceIn 1s linear 1;
    }

    .wrapper {
        z-index: 10;
        position: relative;
    }

    .bubbles {
        position: relative;
        width:45px;
        height:45px;
        background-image: url('custom/bloom/ic_load_bubbles.png');
        background-size: cover;
        z-index: -1;
        opacity: 0;
    }

    @keyframes bounceIn {
        0% {
            opacity: 1;
            transform: scale3d(0.3, 0.3, 0.3);
        }
        
        30% {
            opacity: 0.8;
            transform: scale3d(0.8, 0.8, 0.8);
        }

        65% {
            
            transform: scale3d(1.1, 1.1, 1.1);
        }

        70% {
            opacity: 0;
            transform: scale3d(1.25, 1.25, 1.25);
        }

        100% {
            opacity: 0;
            transform: scale3d(1.3, 1.3, 1.3);
        }
    }
</style>

<script>
    class CustomBloom extends HTMLElement{

        get value () {
            return this.getAttribute('value') || 0;
        }

        set value (val) {
            this.setAttribute('value', val);
            this.select(this.value - 1);
        }

        get enabled () {
            return this.getAttribute('enabled') || true;
        }

        set enabled (val) {
            this.setAttribute('enabled', val);
        }

        constructor(){
            super();

            this.stars = [];

            for (var i = 0; i < 5; i++) {
                let wrapper = document.createElement('div');
                wrapper.className = 'wrapper';

                let bg = document.createElement('div');
                bg.className = 'bubbles';

                let s = document.createElement('div');
                s.className = 'star';
                s.appendChild(bg)
                wrapper.appendChild(s)

                this.appendChild(wrapper);
                this.stars.push(s);
            }

            //This has to be after the loop...
            this.value = this.value;
            this.enabled = this.enabled;

            this.addEventListener('click', this.getClickFunction, false);
        }

        select(index){
            this.stars.forEach((star,i) => {
                star.classList.toggle('full', i <= index );
                $(star).html("")
                if (i <= index) {
                    let bg = document.createElement('div');
                    bg.className = 'bubbles';
                    star.appendChild(bg)
                }
            });
        }

        getClickFunction(e) {

                if(this.enabled + '' === 'true'){

                    //Get current child:
                    e = e || window.event;
                    var currentChild = e.target || e.srcElement, text = currentChild.textContent || currentChild.innerText;

                    //get current position:
                    var pos = 0;
                    currentChild = currentChild.parentElement
                    while( (currentChild = currentChild.previousSibling) != null ){
                        pos++;
                    }

                    this.value = pos;

                    //Every time the user clicks in a star, dispatch this event.
                    let rateEvent = new Event('rate');
                    this.dispatchEvent(rateEvent);
                }
        }

    }

    //This makes the DOM recognize the custom HTML element:
    if(!window.customElements.get('custom-bloom')){
        window.customElements.define('custom-bloom', CustomBloom);
    }


</script>
