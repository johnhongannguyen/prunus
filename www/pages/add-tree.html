<!-- SINGLE-FILE-COMPONENT -->
<!-- https://framework7.io/docs/router-component.html#single-file-component -->

<template>
    <div class="page" data-name="add-tree">

        <!-- Scrollable PAGE CONTENT-->
        <div class="page-content">

            <div id='container'>
                <div id="group1">

                    <div class="background">
                        <img id="img-tree" src="{{tree.img_url}}" alt="Tree picture">
                    </div>

                    <div class="elevation-4 bottom-border">
                        <div class="foreground user-reaction bottom-border top-border">
                            <img src="img/pin-flower-shadow.png" alt="Pin Flower" class="pin-flower">

                            

                            <!-- RATING -->
                            <div class="field input-section">
                                <!-- <div class="section-title">RATING</div> -->
                                <div class="rating">
                                    <!-- custom-rating element will go here -->
                                </div>
                            </div>


                            <div class="hr-wrapper">
                                <img class="hr" src="img/hr.png" alt="hr">
                            </div>

                            <!-- BLOOM -->
                            <div class="field input-section">
                                <!-- <div id="title-bloom" class="section-title">BLOOM</div> -->
                                <div class="bloom">
                                    <!-- custom-bloom element will go here -->
                                </div>
                            </div>


                            <div class="hr-wrapper">
                                <img class="hr" src="img/hr.png" alt="hr">
                            </div>

                            <!-- STATUS -->
                            <!-- <div class="field input-section">
                            <div class="section-title">STATUS</div>
                            <div class="status-flex-box">
                            <div data-bloom="1" class="elevation-4">Blossoming</div>
                            <div data-bloom="2" class="elevation-4">Growing</div>
                            <div data-bloom="3" class="elevation-4">Blooming</div>
                        </div>

                    </div>

                    <div class="hr-wrapper">
                    <img class="hr" src="img/hr.png" alt="hr">
                </div> -->


                <!-- LOCATION -->
                <div class="field input-section">
                    <!-- <div class="section-title">LOCATION</div> -->
                    <div class="flex-box hidden">
                        <span>Latitude: <span id="lat">{{tree.lat}}</span></span>
                        <span>Longitude: <span id="lng">{{tree.lng}}</span></span>
                    </div>


                    <div class="tree-address-container">
                        <img id="ic_tree_address" src="img/ic_tree_address.png" alt="">
                        <div id="tree-address-load" class="preloader color-red"></div>
                        <span id="tree-address"></span>
                    </div>
                    <!-- <span id="tree-address"></span> -->

                </div>

                <!-- <div class="action-bar">
                <button id="btn-register-tree">Submit</button>
            </div> -->
        </div>
        <div id="btn-register-tree" class="fab color-black">
            <a href="#">
                <img src="img/ic-plant-seed.png" alt="Plant tree icon">
            </a>
            <!-- <img src="https://firebasestorage.googleapis.com/v0/b/prunus-8d0a2.appspot.com/o/icons%2Fadd_tree_icon_35px.png?alt=media&token=39dac19c-9345-4c6c-b76d-e27405e4f43f" alt="Add tree icon"> -->
        </div>
    </div>
</div>
</div>

</div>
</div>

</template>
<!-- component styles -->

<style>

    #btn-register-tree img {
        width: initial;
    }

    .user-reaction {
        padding: 1rem;
        background: #fff;

        /* TODO - remove this */
        padding-bottom: 2rem;
    }


    /* Spacing between each row: */
    /* .field {
    margin-bottom: 3rem;
} */

/* centering radio buttons: */
.field .radio i {
    margin:auto;
}

.flex-box {
    display: flex;
    justify-content: space-between
}

.action-bar {
    display: flex;
    flex-direction: column
}

.action-bar button {
    padding: 10px;
    margin-top: 20px;
}


@media screen and (min-width:900px) {
    .foreground {
        top: 80vh;
    }

    .background img {
        max-height:80vh;
    }
}

</style>
<!-- rest of component data and methods -->
<script>
    // script must return component object
    return {

        data: function () {
            return {

                tree: new Tree(),    //This var is stored in index.js

            }
        },

        on: {
            pageInit: function () {
                // do something on page init
                var self = this;

                //Getting the tree from the router:
                self.tree = mainView.router.currentRoute.context.tree;
                self.$setState();    //Forcing the view to reset

                $(".rating").load("custom/rating/custom-rating.html", function() {
                    $('custom-rating').on('rate', () => {

                        console.log("new value..");
                        //new value assigned:
                        self.tree.rating = $('custom-rating').val();
                        console.log("...done!");
                    });
                });

                $(".bloom").load("custom/bloom/custom-bloom.html", function() {
                    $('custom-bloom').on('rate', () => {

                        console.log("new value..");
                        //new value assigned:
                        self.tree.blooming = $('custom-bloom').val();
                        console.log("...done!");
                    });
                });

                treeLocationService.getAddress(self.tree.lat, self.tree.lng, function(address){
                    self.tree.address = address;
                    $("#tree-address-load").hide();
                    $("#tree-address").append(address);
                });


                // $(".status-flex-box div").click(function() {
                //     $(".status-flex-box div").removeClass("status-selected")
                //     $(this).addClass("status-selected")
                //     // alert($(".status-selected").attr("data-bloom"))
                // })


                //SUBMIT CLICK:
                $("#btn-register-tree").click(function(){

                    //blooming status
                    // var blooming = $("input[type='range']").val();
                    // var blooming = $(".status-selected").attr("data-bloom")
                    // blooming = parseInt(blooming);
                    // var blooming = 0;



                    //Check if user is logged:
                    if(auth.getCurrentUser()){

                        registerTree();

                    } else {


                        //If user not logged then do the login flow:

                        var dialog = app.dialog.create({
                            title: 'Login',
                            text: 'Sign in to add the tree.',
                            content: '<div class="dialog-input-field item-input" style="margin-top: 15px;"><button type="button" class="button" id="btnFacebook">Facebook</button><button type="button" class="button" id="btnGoogle">Google</button></div>',
                            buttons: [
                            {
                                text: 'Cancel',
                            },

                            ],
                            onClick(dialog, index) {

                                if(index === 0){
                                    dialog.close();
                                }

                                // const inputValue = dialog.$el.find('.dialog-input').val();
                                // if (index === 0 && callbackCancel) callbackCancel(inputValue);
                                // if (index === 1 && callbackOk) callbackOk(inputValue);
                            },
                            //verticalButtons: true,
                            on: {
                                open: function () {

                                    $("#btnGoogle").click(function () {
                                        auth.loginWithGoogle(function(error){
                                            if(error){
                                                //Something went wrong...
                                            } else {
                                                dialog.close();
                                                registerTree();
                                            }
                                        });
                                    });

                                    $("#btnFacebook").click(function (){
                                        auth.loginWithFacebook(function(error){
                                            if(error){
                                                //Something went wrong...
                                            } else {
                                                dialog.close();
                                                registerTree();
                                            }
                                        });
                                    });

                                } //End open:

                            }    //End on:

                        }).open();


                    } //End else




                    function registerTree(){
                        //If user is logged save the tree:
                        app.preloader.show();

                        //img, [latlng], address, blooming, rating, user
                        treeCRUD.write(self.tree.img_url, [self.tree.lat, self.tree.lng], self.tree.address, self.tree.blooming, self.tree.rating, auth.getCurrentUser(), function(){

                            app.preloader.hide();
                            appNavigator.onBackPressed();
                        });
                    }

                });

            },
            pageAfterOut: function () {
                // page has left the view
            },
        }
    }
</script>
