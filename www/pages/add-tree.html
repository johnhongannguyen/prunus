<!-- SINGLE-FILE-COMPONENT -->
<!-- https://framework7.io/docs/router-component.html#single-file-component -->

<template>
    <div class="page" data-name="add-tree">

        <!-- Scrollable PAGE CONTENT-->
        <div class="page-content">

            <div id='container'>
                <div id="group1">

                    <div class="background">
                        <img id="img-tree" src="{{tree.img_url}}" alt="Tree picture">
                    </div>

                    <div class="foreground user-reaction elevation-12">
                        <!-- RATING -->
                        <div class="field">
                            <div class="flex-box">
                                <label class="radio"><input type="radio" name="emotion" value="1"><i class="icon-radio"></i>Happy</label>
                                <label class="radio"><input type="radio" name="emotion" value="2"><i class="icon-radio"></i>Amazed</label>
                                <label class="radio"><input type="radio" name="emotion" value="3"><i class="icon-radio"></i>Stunned</label>
                            </div>
                        </div>


                        <!-- STATUS -->
                        <div class="field">
                            <div class="flex-box">
                                <span>Growing</span>
                                <span>Blossoming</span>
                                <span>Fully Bloomed</span>
                            </div>

                            <div class="item-input-wrap">
                                <div class="range-slider range-slider-init" data-label="true">
                                    <input type="range" value="0" min="0" max="2" step="1">
                                </div>
                            </div>
                        </div>


                        <!-- LOCATION -->
                        <div class="field">
                            <h2>Location info</h2>
                            <div class="flex-box">
                                <span>Latitude: <span id="lat">{{tree.lat}}</span></span>
                                <span>Longitude: <span id="lng">{{tree.lng}}</span></span>
                            </div>
                        </div>

                        <div class="action-bar">
                            <button id="btn-register-tree">Submit</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

</template>
<!-- component styles -->

<style>
    .user-reaction {
        padding: 1rem;
        background: #eee;

        /* TODO - remove this */
        padding-bottom: 200px;
    }


    /* Spacing between each row: */
    .field {
        margin-bottom: 3rem;
    }

    /* centering radio buttons: */
    .field .radio i {
        margin:auto;
    }

    .flex-box {
        display: flex;
        justify-content: space-between
    }

    .action-bar {
        display: flex;
        flex-direction: column
    }

    .action-bar button {
        padding: 10px;
        margin-top: 20px;
    }


    @media screen and (min-width:900px) {
        .foreground {
            top: 80vh;
        }

        .background img {
            max-height:80vh;
        }
    }

</style>
<!-- rest of component data and methods -->
<script>
    // script must return component object
    return {

        data: function () {
            return {

                tree: new Tree(),    //This var is stored in index.js

            }
        },

        on: {
            pageInit: function () {
                // do something on page init
                var self = this;

                //Getting the tree from the router:
                self.tree = mainView.router.currentRoute.context.tree;
                self.$setState();    //Forcing the view to reset


                //SUBMIT CLICK:
                $("#btn-register-tree").click(function(){



                    //rating
                    var rating = 0;
                    $.each($("input[name='emotion']:checked"), function(){
                        rating = $(this).val();
                    });
                    rating = parseInt(rating);



                    //blooming status
                    var blooming = $("input[type='range']").val();
                    blooming = parseInt(blooming);



                    //Check if user is logged:
                    if(auth.getCurrentUser()){

                        registerTree();

                    } else {


                        //If user not logged then do the login flow:

                        var dialog = app.dialog.create({
                            title: 'Login',
                            text: 'Sign in to add the tree.',
                            content: '<div class="dialog-input-field item-input" style="margin-top: 15px;"><button type="button" class="button" id="btnFacebook">Facebook</button><button type="button" class="button" id="btnGoogle">Google</button></div>',
                            buttons: [
                            {
                                text: 'Cancel',
                            },

                            ],
                            onClick(dialog, index) {

                                if(index === 0){
                                    dialog.close();
                                }

                                // const inputValue = dialog.$el.find('.dialog-input').val();
                                // if (index === 0 && callbackCancel) callbackCancel(inputValue);
                                // if (index === 1 && callbackOk) callbackOk(inputValue);
                            },
                            //verticalButtons: true,
                            on: {
                                open: function () {

                                    $("#btnGoogle").click(function () {
                                        auth.loginWithGoogle(function(error){
                                            if(error){
                                                //Something went wrong...
                                            } else {
                                                dialog.close();
                                                registerTree();
                                            }
                                        });
                                    });

                                    $("#btnFacebook").click(function (){
                                        auth.loginWithFacebook(function(error){
                                            if(error){
                                                //Something went wrong...
                                            } else {
                                                dialog.close();
                                                registerTree();
                                            }
                                        });
                                    });

                                } //End open:

                            }    //End on:

                        }).open();


                    } //End else




                    function registerTree(){
                        //If user is logged save the tree:
                        app.preloader.show();

                        treeCRUD.write(auth.getCurrentUser(), self.tree.img_url, rating, blooming, [self.tree.lat, self.tree.lng], function(){

                            app.preloader.hide();
                            appNavigator.onBackPressed();
                        });
                    }

                });

            },
            pageAfterOut: function () {
                // page has left the view
            },
        }
    }
</script>
